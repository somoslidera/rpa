<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Performance - Roselaine Portal Advocacia</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o do Tailwind -->
    <script>
      tailwind.config = {
        darkMode: 'class', // Habilita modo escuro via classe
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
                dark: {
                    bg: '#0f172a',
                    card: '#1e293b',
                    text: '#f1f5f9',
                    border: '#334155'
                }
            }
          },
        }
      }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Fonte Inter e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Transi√ß√£o suave para dark mode */
        body, div, p, h1, h2, span, table, td, th {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        @media print {
            .no-print { display: none !important; }
            body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-slate-900 dark:text-gray-100 p-4 sm:p-6 transition-colors duration-300">

    <div id="app" class="max-w-7xl mx-auto space-y-6">
        
        <!-- Cabe√ßalho e Toggle Dark Mode -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b-2 border-indigo-500 pb-4 mb-2">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700 dark:text-indigo-400">Roselaine Portal Advocacia</h1>
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mt-1">Painel de Performance em Tr√°fego Pago</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 italic">Lidera Solu√ß√µes - Por Rodrigo Ribas</p>
            </div>
            
            <div class="flex items-center gap-4 mt-4 md:mt-0 no-print">
                <!-- Bot√£o Toggle Theme -->
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 transition focus:outline-none" title="Alternar Tema">
                    <i id="theme-icon" class="fas fa-moon text-gray-700 dark:text-yellow-300 text-lg w-6 h-6 flex items-center justify-center"></i>
                </button>
            </div>
        </div>

        <!-- Barra de Ferramentas: Filtros e Exporta√ß√£o (No Print) -->
        <div class="no-print bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md flex flex-col lg:flex-row gap-4 justify-between items-center border border-gray-100 dark:border-slate-700">
            <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                <!-- Filtro M√™s -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-calendar text-gray-400"></i>
                    </div>
                    <select id="month-filter" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 text-sm focus:ring-indigo-500 focus:border-indigo-500 py-2.5">
                        <option value="Todos">Todos os Meses</option>
                    </select>
                </div>
                <!-- Filtro Campanha -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-bullhorn text-gray-400"></i>
                    </div>
                    <select id="campaign-filter" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 text-sm focus:ring-indigo-500 focus:border-indigo-500 py-2.5">
                        <option value="Todas">Todas as Campanhas</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 w-full lg:w-auto">
                <button onclick="downloadCSV()" class="flex-1 lg:flex-none inline-flex justify-center items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition shadow-sm">
                    <i class="fas fa-file-csv mr-2"></i> CSV
                </button>
                <button onclick="downloadPDF()" class="flex-1 lg:flex-none inline-flex justify-center items-center px-4 py-2 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-slate-600 text-sm font-medium rounded-lg transition shadow-sm">
                    <i class="fas fa-file-pdf mr-2"></i> PDF
                </button>
            </div>
        </div>

        <!-- Se√ß√£o: Indicador de Efici√™ncia (ROI/ROAS) -->
        <div id="efficiency-indicator-section" class="bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-700 dark:to-purple-700 p-6 rounded-xl shadow-lg text-white">
            <!-- Injetado via JS -->
        </div>

        <!-- Se√ß√£o: Totais e M√©dias (KPIs) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="kpi-section">
            <!-- Cards injetados via JS -->
        </div>

        <!-- Se√ß√£o: Scorecards CPM, CPC, CTR -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="metrics-scorecards">
            <!-- Cards injetados via JS -->
        </div>

        <!-- Se√ß√£o: Destaques (Melhor M√™s/Campanha) e Gr√°fico Rosca -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Destaques -->
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="best-month-card" class="bg-gradient-to-br from-indigo-50 to-white dark:from-slate-800 dark:to-slate-800 p-6 rounded-xl shadow border border-indigo-100 dark:border-slate-600 relative overflow-hidden">
                    <!-- Injetado via JS -->
                </div>
                <div id="best-campaign-card" class="bg-gradient-to-br from-emerald-50 to-white dark:from-slate-800 dark:to-slate-800 p-6 rounded-xl shadow border border-emerald-100 dark:border-slate-600 relative overflow-hidden">
                    <!-- Injetado via JS -->
                </div>
                <!-- Scorecard de CPA (Original) Movido para c√° -->
                <div id="cpa-scorecard" class="md:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
                    <!-- Injetado via JS -->
                </div>
            </div>

            <!-- Gr√°fico de Rosca (Top Vendas) -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700 flex flex-col">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4 text-center">Top 5 Campanhas (Vendas)</h3>
                <div class="flex-grow relative h-80"> <!-- CORRIGIDO: Adicionado h-80 -->
                    <canvas id="topCampaignsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Gr√°ficos de Linha/Barra -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Investimento vs Vendas -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Investimento vs. Vendas</h3>
                <div class="h-80"> <!-- CORRIGIDO: Adicionado h-80 para limitar a altura -->
                    <canvas id="investimentoVendasChart"></canvas>
                </div>
            </div>
            <!-- Leads vs Vendas -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Leads vs. Vendas</h3>
                <div class="h-80"> <!-- CORRIGIDO: Adicionado h-80 para limitar a altura -->
                    <canvas id="leadsVendasVolumeChart"></canvas>
                </div>
            </div>
            <!-- Efici√™ncia CPL/CPA -->
            <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Efici√™ncia de Custo (CPL & CPA)</h3>
                <div class="h-96"> <!-- CORRIGIDO: Adicionado h-96 para limitar a altura (gr√°fico maior) -->
                    <canvas id="custoEficienciaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Funil Acumulado -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Funil de Marketing Acumulado</h3>
            <div id="funnel-section" class="space-y-4">
                <!-- Injetado via JS -->
            </div>
        </div>

        <!-- Se√ß√£o: Tabela Resumo -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Resumo Mensal Consolidado</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                    <thead class="bg-gray-50 dark:bg-slate-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">M√™s</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Investimento</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Leads</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Vendas</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">CPL</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">CPA</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-gray-200 dark:divide-slate-700 text-sm">
                        <!-- JS Populate -->
                    </tbody>
                </table>
            </div>
        </div>

         <!-- Se√ß√£o: Tabela Detalhada -->
         <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-gray-100 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Detalhamento Completo (Por Campanha/M√™s)</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                    <thead class="bg-gray-50 dark:bg-slate-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">M√™s</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Campanha</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Invest.</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Impr.</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Cliques</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Leads</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Vendas</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">CPL</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wider">CPA</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y divide-gray-200 dark:divide-slate-700 text-sm">
                        <!-- JS Populate -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script>
        // DADOS BRUTOS (Fonte √önica da Verdade)
        const rawDetailedData = [
            { mes: 'ago/2025', campanha: 'Energia-PR', investimento: 198.73, impressoes: 13586, cliques: 117, leads: 22, vendas: 0, cpm: 14.63, cpc: 1.70, cpl: 9.03, cpa: NaN },
            { mes: 'ago/2025', campanha: 'Energia-RS', investimento: 1041.71, impressoes: 109097, cliques: 967, leads: 374, vendas: 68, cpm: 9.55, cpc: 1.08, cpl: 2.79, cpa: 15.32 },
            { mes: 'ago/2025', campanha: 'Energia-PE', investimento: 584.53, impressoes: 47714, cliques: 592, leads: 239, vendas: 25, cpm: 12.25, cpc: 0.99, cpl: 2.45, cpa: 23.38 },
            { mes: 'set/2025', campanha: 'Energia-PR', investimento: 199.00, impressoes: 13568, cliques: 117, leads: 12, vendas: 0, cpm: 14.67, cpc: 1.70, cpl: 16.58, cpa: NaN },
            { mes: 'set/2025', campanha: 'Energia-RS', investimento: 1919.00, impressoes: 209842, cliques: 1602, leads: 616, vendas: 146, cpm: 9.14, cpc: 1.20, cpl: 3.12, cpa: 13.14 },
            { mes: 'set/2025', campanha: 'Energia-PE', investimento: 1278.00, impressoes: 115836, cliques: 1207, leads: 445, vendas: 67, cpm: 11.03, cpc: 1.06, cpl: 2.87, cpa: 19.07 },
            { mes: 'out/2025', campanha: 'Energia-RS', investimento: 1541.72, impressoes: 184420, cliques: 1278, leads: 437, vendas: 120, cpm: 8.36, cpc: 1.21, cpl: 3.53, cpa: 12.85 },
            { mes: 'out/2025', campanha: 'Energia-PE', investimento: 1961.61, impressoes: 187031, cliques: 1504, leads: 377, vendas: 50, cpm: 10.49, cpc: 1.30, cpl: 5.20, cpa: 39.23 },
            { mes: 'out/2025', campanha: 'Ve√≠culo-RS', investimento: 1149.49, impressoes: 26634, cliques: 962, leads: 36, vendas: 0, cpm: 43.16, cpc: 1.19, cpl: 31.93, cpa: NaN },
            { mes: 'out/2025', campanha: 'Empr√©stimo-RS', investimento: 1636.82, impressoes: 54544, cliques: 741, leads: 171, vendas: 1, cpm: 30.01, cpc: 2.21, cpl: 9.57, cpa: 1636.82 },
            { mes: 'out/2025', campanha: 'Lia-RS', investimento: 66.78, impressoes: 7357, cliques: 83, leads: 62, vendas: 1, cpm: 9.08, cpc: 0.80, cpl: 1.08, cpa: 66.78 },
            { mes: 'nov/2025', campanha: 'Energia-RS', investimento: 598.88, impressoes: 63238, cliques: 398, leads: 171, vendas: 100, cpm: 9.47, cpc: 1.50, cpl: 3.50, cpa: 5.99 },
            { mes: 'nov/2025', campanha: 'Energia-PE', investimento: 718.22, impressoes: 64109, cliques: 723, leads: 387, vendas: 63, cpm: 11.20, cpc: 0.99, cpl: 1.86, cpa: 11.40 },
            { mes: 'nov/2025', campanha: 'Credi√°rio-RS', investimento: 352.77, impressoes: 12960, cliques: 176, leads: 37, vendas: 0, cpm: 27.22, cpc: 2.00, cpl: 9.53, cpa: NaN },
            { mes: 'nov/2025', campanha: 'Ve√≠culo-RS', investimento: 420.97, impressoes: 54654, cliques: 960, leads: 4, vendas: 0, cpm: 7.70, cpc: 0.44, cpl: 105.24, cpa: NaN },
            { mes: 'nov/2025', campanha: 'Lia-RS', investimento: 442.60, impressoes: 35008, cliques: 310, leads: 235, vendas: 17, cpm: 12.64, cpc: 1.43, cpl: 1.88, cpa: 26.04 },
            { mes: 'nov/2025', campanha: 'Empr√©stimo-RS', investimento: 159.28, impressoes: 6933, cliques: 58, leads: 39, vendas: 0, cpm: 22.97, cpc: 2.75, cpl: 4.08, cpa: NaN },
            { mes: 'dez/2025', campanha: 'Empr√©stimo-RS', investimento: 1200.34, impressoes: 75563, cliques: 629, leads: 437, vendas: 24, cpm: 15.89, cpc: 1.91, cpl: 2.75, cpa: 50.01 },
            { mes: 'dez/2025', campanha: 'Energia-RS', investimento: 1092.89, impressoes: 95386, cliques: 624, leads: 420, vendas: 130, cpm: 11.46, cpc: 1.75, cpl: 2.60, cpa: 8.41 },
            { mes: 'dez/2025', campanha: 'Lia-RS', investimento: 472.44, impressoes: 35102, cliques: 281, leads: 297, vendas: 21, cpm: 13.46, cpc: 1.68, cpl: 1.59, cpa: 22.50 },
            { mes: 'dez/2025', campanha: 'Post Carro', investimento: 103.42, impressoes: 3258, cliques: 14, leads: 9, vendas: 0, cpm: 31.74, cpc: 7.39, cpl: 11.49, cpa: NaN }
        ];

        let chartInstances = {};
        let isDarkMode = false;

        // --- Helpers ---
        const fmtBRL = (v) => (v || v===0) ? v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : '-';
        const fmtNum = (v) => (v || v===0) ? v.toLocaleString('pt-BR') : '-';
        const fmtPct = (v) => (v || v===0) ? (v * 100).toFixed(2).replace('.', ',') + '%' : '-';
        const getCpaColor = (cpa) => (!cpa || cpa >= 35) ? 'text-red-500 font-bold' : 'text-green-500 font-bold';
        const CPA_META = 35; // Meta de CPA em R$
        
        // Fun√ß√£o para calcular cor do mapa de calor
        function getHeatMapColor(value, min, max, isDark = false) {
            if (value === null || value === undefined || isNaN(value)) return '';
            if (min === max) return '';
            
            const normalized = (value - min) / (max - min);
            const opacity = 0.15 + (normalized * 0.25); // Opacidade entre 0.15 e 0.4
            
            if (isDark) {
                // Para modo escuro, usar cores mais claras
                const hue = normalized < 0.5 ? 220 : 150; // Azul para baixo, verde para alto
                return `background-color: hsla(${hue}, 70%, 50%, ${opacity})`;
            } else {
                // Para modo claro, usar cores padr√£o
                const hue = normalized < 0.5 ? 200 : 140; // Azul para baixo, verde para alto
                return `background-color: hsla(${hue}, 70%, 90%, ${opacity})`;
            }
        }
        
        // --- Dark Mode Logic ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = 'fas fa-moon text-gray-700 text-lg w-6 h-6 flex items-center justify-center';
                isDarkMode = false;
            } else {
                html.classList.add('dark');
                icon.className = 'fas fa-sun text-yellow-300 text-lg w-6 h-6 flex items-center justify-center';
                isDarkMode = true;
            }
            // Re-renderizar gr√°ficos para ajustar cores
            updateReport(); 
        }

        // --- Core Logic ---
        function getUniqueValues(key) {
            return [...new Set(rawDetailedData.map(item => item[key]))].sort();
        }

        function populateFilters() {
            const monthFilter = document.getElementById('month-filter');
            const campaignFilter = document.getElementById('campaign-filter');
            getUniqueValues('mes').forEach(m => monthFilter.add(new Option(m, m)));
            getUniqueValues('campanha').forEach(c => campaignFilter.add(new Option(c, c)));
        }

        function getFilteredData() {
            const m = document.getElementById('month-filter').value;
            const c = document.getElementById('campaign-filter').value;
            return rawDetailedData.filter(i => (m === 'Todos' || i.mes === m) && (c === 'Todas' || i.campanha === c));
        }

        function updateReport() {
            const filtered = getFilteredData();
            
            // Agrupamento por M√™s
            const monthlyData = Object.values(filtered.reduce((acc, curr) => {
                if (!acc[curr.mes]) acc[curr.mes] = { mes: curr.mes, inv: 0, leads: 0, vendas: 0 };
                acc[curr.mes].inv += curr.investimento;
                acc[curr.mes].leads += curr.leads;
                acc[curr.mes].vendas += curr.vendas;
                return acc;
            }, {})).map(d => ({
                ...d, 
                cpl: d.leads ? d.inv/d.leads : 0, 
                cpa: d.vendas ? d.inv/d.vendas : 0 
            })).sort((a,b) => {
                const order = ['ago/2025', 'set/2025', 'out/2025', 'nov/2025', 'dez/2025'];
                return order.indexOf(a.mes) - order.indexOf(b.mes);
            });

            // Agrupamento por Campanha (para Rosca e Melhor Campanha)
            const campaignData = Object.values(filtered.reduce((acc, curr) => {
                if (!acc[curr.campanha]) acc[curr.campanha] = { campanha: curr.campanha, vendas: 0, inv: 0 };
                acc[curr.campanha].vendas += curr.vendas;
                acc[curr.campanha].inv += curr.investimento;
                return acc;
            }, {}));

            // Atualiza√ß√µes Visuais
            renderEfficiencyIndicator(filtered);
            renderKPIGrid(monthlyData, filtered);
            renderMetricsScorecards(filtered);
            renderBestPerformers(monthlyData, campaignData);
            renderScorecard(monthlyData);
            renderFunnel(filtered);
            renderCharts(monthlyData, campaignData);
            renderSummaryTable(monthlyData);
            renderDetailedTable(filtered);
        }

        // --- Renderers ---

        function renderEfficiencyIndicator(filtered) {
            const totalInv = filtered.reduce((s, i) => s + i.investimento, 0);
            const totalSales = filtered.reduce((s, i) => s + i.vendas, 0);
            const totalCPA = totalSales ? totalInv / totalSales : 0;
            
            // Efici√™ncia = (Meta CPA / CPA Real) * 100%
            // Se CPA < 35, efici√™ncia > 100% (superou a meta)
            // Se CPA > 35, efici√™ncia < 100% (abaixo da meta)
            const efficiency = totalCPA > 0 ? (CPA_META / totalCPA) * 100 : 0;
            const isGood = efficiency >= 100;
            
            // Calcular a porcentagem visual (limitar a 100% para a barra)
            const visualPercentage = Math.min(efficiency, 100);
            const barColor = isGood ? 'bg-green-400' : 'bg-orange-400';
            
            const container = document.getElementById('efficiency-indicator-section');
            container.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold mb-1">Efici√™ncia de Investimento</h3>
                        <h2 class="text-3xl font-bold mb-2">${efficiency.toFixed(1)}%</h2>
                        <p class="text-xs opacity-80">
                            C√°lculo: (${fmtBRL(CPA_META)} √∑ ${fmtBRL(totalCPA)}) √ó 100 = ${efficiency.toFixed(1)}%
                        </p>
                        <p class="text-xs opacity-70 mt-1">
                            Meta: ${fmtBRL(CPA_META)} por venda | Real: ${fmtBRL(totalCPA)} por venda
                        </p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold">${fmtNum(totalSales)}</p>
                            <p class="text-xs opacity-80">Vendas Totais</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold">${fmtBRL(totalInv)}</p>
                            <p class="text-xs opacity-80">Investimento Total</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 bg-opacity-20 p-3 rounded-lg">
                            <i class="fas ${isGood ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'} text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-4 w-full bg-white dark:bg-slate-800 bg-opacity-20 rounded-full h-3">
                    <div class="${barColor} h-3 rounded-full transition-all duration-500" 
                         style="width: ${visualPercentage}%"></div>
                </div>
            `;
        }

        function renderMetricsScorecards(filtered) {
            const totalImpressoes = filtered.reduce((s, i) => s + i.impressoes, 0);
            const totalCliques = filtered.reduce((s, i) => s + i.cliques, 0);
            const totalInvestimento = filtered.reduce((s, i) => s + i.investimento, 0);
            
            // CPM = (Investimento / Impress√µes) * 1000
            const cpm = totalImpressoes > 0 ? (totalInvestimento / totalImpressoes) * 1000 : 0;
            
            // CPC = Investimento / Cliques
            const cpc = totalCliques > 0 ? totalInvestimento / totalCliques : 0;
            
            // CTR = (Cliques / Impress√µes) * 100
            const ctr = totalImpressoes > 0 ? (totalCliques / totalImpressoes) * 100 : 0;
            
            const container = document.getElementById('metrics-scorecards');
            container.innerHTML = `
                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-blue-500 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold">CPM</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-gray-100 mt-1">${fmtBRL(cpm)}</p>
                            <p class="text-xs text-gray-400 mt-1">Custo por 1.000 impress√µes</p>
                        </div>
                        <i class="fas fa-eye text-blue-500 opacity-80 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-purple-500 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold">CPC</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-gray-100 mt-1">${fmtBRL(cpc)}</p>
                            <p class="text-xs text-gray-400 mt-1">Custo por clique</p>
                        </div>
                        <i class="fas fa-mouse-pointer text-purple-500 opacity-80 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-green-500 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold">CTR</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-gray-100 mt-1">${ctr.toFixed(2)}%</p>
                            <p class="text-xs text-gray-400 mt-1">Taxa de clique</p>
                        </div>
                        <i class="fas fa-chart-line text-green-500 opacity-80 text-2xl"></i>
                    </div>
                </div>
            `;
        }

        function renderFunnel(filtered) {
            // Calcular totais acumulados
            const totalImpressoes = filtered.reduce((s, i) => s + i.impressoes, 0);
            const totalCliques = filtered.reduce((s, i) => s + i.cliques, 0);
            const totalLeads = filtered.reduce((s, i) => s + i.leads, 0);
            const totalVendas = filtered.reduce((s, i) => s + i.vendas, 0);
            
            // Calcular taxas de convers√£o
            const ctr = totalImpressoes > 0 ? (totalCliques / totalImpressoes) * 100 : 0;
            const leadRate = totalCliques > 0 ? (totalLeads / totalCliques) * 100 : 0;
            const saleRate = totalLeads > 0 ? (totalVendas / totalLeads) * 100 : 0;
            const overallRate = totalImpressoes > 0 ? (totalVendas / totalImpressoes) * 100 : 0;
            
            // Propor√ß√µes visuais mais equilibradas para formar um funil (n√£o totalmente realistas)
            // Usando raiz quadrada para suavizar as diferen√ßas
            const impWidth = 100;
            const clickWidth = 75; // Aproximadamente baseado na taxa de convers√£o t√≠pica
            const leadWidth = 50;  // Meio do caminho
            const saleWidth = 25;  // Menor mas ainda vis√≠vel
            
            // Alturas fixas para um funil mais uniforme
            const height = 80;
            
            const container = document.getElementById('funnel-section');
            container.innerHTML = `
                <div class="flex flex-col items-center space-y-4">
                    <!-- Impress√µes -->
                    <div class="w-full flex flex-col items-center">
                        <div class="flex justify-between items-center mb-2 w-full max-w-md">
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Impress√µes</span>
                            <span class="text-sm font-bold text-gray-800 dark:text-white">${fmtNum(totalImpressoes)}</span>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg transition-all duration-500 flex items-center justify-center text-white font-semibold shadow-md" 
                             style="width: ${impWidth}%; max-width: 600px; height: ${height}px;">
                            ${fmtNum(totalImpressoes)}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Base inicial</p>
                    </div>
                    
                    <!-- Cliques -->
                    <div class="w-full flex flex-col items-center">
                        <div class="flex justify-between items-center mb-2 w-full max-w-md">
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Cliques</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-gray-800 dark:text-white">${fmtNum(totalCliques)}</span>
                                <span class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-2 py-0.5 rounded">${ctr.toFixed(2)}% CTR</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg transition-all duration-500 flex items-center justify-center text-white font-semibold shadow-md" 
                             style="width: ${clickWidth}%; max-width: 450px; height: ${height}px;">
                            ${fmtNum(totalCliques)}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Taxa de convers√£o: ${ctr.toFixed(2)}%</p>
                    </div>
                    
                    <!-- Leads -->
                    <div class="w-full flex flex-col items-center">
                        <div class="flex justify-between items-center mb-2 w-full max-w-md">
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Leads</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-gray-800 dark:text-white">${fmtNum(totalLeads)}</span>
                                <span class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-2 py-0.5 rounded">${leadRate.toFixed(2)}%</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg transition-all duration-500 flex items-center justify-center text-white font-semibold shadow-md" 
                             style="width: ${leadWidth}%; max-width: 300px; height: ${height}px;">
                            ${fmtNum(totalLeads)}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Taxa de convers√£o: ${leadRate.toFixed(2)}% (cliques ‚Üí leads)</p>
                    </div>
                    
                    <!-- Vendas -->
                    <div class="w-full flex flex-col items-center">
                        <div class="flex justify-between items-center mb-2 w-full max-w-md">
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Vendas</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-gray-800 dark:text-white">${fmtNum(totalVendas)}</span>
                                <span class="text-xs bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 px-2 py-0.5 rounded">${saleRate.toFixed(2)}%</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-lg transition-all duration-500 flex items-center justify-center text-white font-semibold shadow-md" 
                             style="width: ${saleWidth}%; max-width: 150px; height: ${height}px;">
                            ${fmtNum(totalVendas)}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Taxa de convers√£o: ${saleRate.toFixed(2)}% (leads ‚Üí vendas) | 
                            Taxa geral: ${overallRate.toFixed(3)}% (impress√µes ‚Üí vendas)
                        </p>
                    </div>
                </div>
            `;
        }

        function renderKPIGrid(monthly, filtered) {
            const totalInv = filtered.reduce((s, i) => s + i.investimento, 0);
            const totalSales = filtered.reduce((s, i) => s + i.vendas, 0);
            const totalLeads = filtered.reduce((s, i) => s + i.leads, 0);
            const monthsCount = monthly.length || 1;

            const avgInv = totalInv / monthsCount;
            const avgSales = totalSales / monthsCount;
            const avgLeads = totalLeads / monthsCount;
            const avgCPL = totalLeads ? totalInv / totalLeads : 0;
            const avgCPA = totalSales ? totalInv / totalSales : 0;

            const kpis = [
                { label: 'Total Investido', val: fmtBRL(totalInv), icon: 'fa-money-bill-wave', color: 'text-indigo-600' },
                { label: 'M√©dia Invest. Mensal', val: fmtBRL(avgInv), icon: 'fa-chart-line', color: 'text-blue-500' },
                { label: 'Vendas Totais', val: fmtNum(totalSales), icon: 'fa-shopping-cart', color: 'text-emerald-600' },
                { label: 'M√©dia Vendas Mensal', val: fmtNum(avgSales), icon: 'fa-cash-register', color: 'text-teal-500' },
                { label: 'Leads Totais', val: fmtNum(totalLeads), icon: 'fa-users', color: 'text-cyan-600' },
                { label: 'M√©dia Leads Mensal', val: fmtNum(avgLeads), icon: 'fa-user-plus', color: 'text-sky-500' },
                { label: 'CPL M√©dio', val: fmtBRL(avgCPL), icon: 'fa-filter', color: 'text-amber-600' },
                { label: 'CPA M√©dio', val: fmtBRL(avgCPA), icon: 'fa-bullseye', color: getCpaColor(avgCPA).split(' ')[0] },
            ];

            const container = document.getElementById('kpi-section');
            container.innerHTML = kpis.map(k => `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 ${k.color.replace('text', 'border')} border-gray-100 dark:border-slate-700 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold">${k.label}</p>
                        <p class="text-lg font-bold text-gray-800 dark:text-gray-100 mt-1">${k.val}</p>
                    </div>
                    <i class="fas ${k.icon} ${k.color} opacity-80 text-xl"></i>
                </div>
            `).join('');
        }

        function renderBestPerformers(monthly, campaignData) {
            // Melhor M√™s (por vendas)
            const bestMonth = [...monthly].sort((a,b) => b.vendas - a.vendas)[0];
            const bmCard = document.getElementById('best-month-card');
            
            if(bestMonth) {
                bmCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-indigo-600 dark:text-indigo-300 mb-1">Melhor M√™s (Vendas)</p>
                            <h4 class="text-2xl font-bold text-gray-800 dark:text-white">${bestMonth.mes}</h4>
                        </div>
                        <div class="bg-indigo-100 dark:bg-indigo-900 p-2 rounded-lg">
                            <i class="fas fa-calendar-check text-indigo-600 dark:text-indigo-300 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <div>
                            <span class="block text-xs text-gray-500 dark:text-gray-400">Vendas</span>
                            <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">${fmtNum(bestMonth.vendas)}</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-500 dark:text-gray-400">CPA</span>
                            <span class="text-lg font-semibold ${getCpaColor(bestMonth.cpa)}">${fmtBRL(bestMonth.cpa)}</span>
                        </div>
                    </div>
                `;
            } else { bmCard.innerHTML = '<p class="text-gray-500 text-sm">Sem dados</p>'; }

            // Melhor Campanha (por vendas)
            const bestCampaign = [...campaignData].sort((a,b) => b.vendas - a.vendas)[0];
            const bcCard = document.getElementById('best-campaign-card');
            
            if(bestCampaign) {
                const cpaCamp = bestCampaign.vendas ? bestCampaign.inv / bestCampaign.vendas : 0;
                bcCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-emerald-600 dark:text-emerald-300 mb-1">Melhor Campanha</p>
                            <h4 class="text-xl font-bold text-gray-800 dark:text-white truncate" title="${bestCampaign.campanha}">${bestCampaign.campanha}</h4>
                        </div>
                        <div class="bg-emerald-100 dark:bg-emerald-900 p-2 rounded-lg flex-shrink-0">
                            <i class="fas fa-trophy text-emerald-600 dark:text-emerald-300 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <div>
                            <span class="block text-xs text-gray-500 dark:text-gray-400">Vendas Totais</span>
                            <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">${fmtNum(bestCampaign.vendas)}</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-500 dark:text-gray-400">CPA M√©dio</span>
                            <span class="text-lg font-semibold ${getCpaColor(cpaCamp)}">${fmtBRL(cpaCamp)}</span>
                        </div>
                    </div>
                `;
            } else { bcCard.innerHTML = '<p class="text-gray-500 text-sm">Sem dados</p>'; }
        }

        function renderScorecard(monthlyData) {
            const div = document.getElementById('cpa-scorecard');
            if (monthlyData.length === 0) { div.innerHTML = ''; return; }
            
            const curr = monthlyData[monthlyData.length - 1];
            const prev = monthlyData.length >= 2 ? monthlyData[monthlyData.length - 2] : null;
            
            let deltaHtml = '<span class="text-gray-400 text-sm">Primeiro per√≠odo</span>';
            if (prev && prev.cpa > 0) {
                const diff = curr.cpa - prev.cpa;
                const diffPct = (diff / prev.cpa) * 100;
                const isGood = curr.cpa < prev.cpa;
                const color = isGood ? 'text-green-500' : 'text-red-500';
                const icon = isGood ? 'fa-arrow-down' : 'fa-arrow-up';
                deltaHtml = `
                    <div class="flex flex-col gap-1">
                        <span class="${color} font-bold flex items-center gap-1">
                            <i class="fas ${icon}"></i> ${(Math.abs(diffPct)).toFixed(1)}%
                        </span>
                        <span class="text-gray-400 text-xs">
                            M√™s anterior: ${fmtBRL(prev.cpa)} | Varia√ß√£o: ${diff > 0 ? '+' : ''}${fmtBRL(diff)}
                        </span>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="flex flex-col h-full justify-between">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-gray-500 dark:text-gray-400 font-medium">CPA Atual (${curr.mes})</h3>
                        <span class="text-xs px-2 py-1 rounded ${curr.cpa < 35 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">Meta: R$ 35,00</span>
                    </div>
                    <div>
                        <div class="text-4xl font-bold ${getCpaColor(curr.cpa)} mb-1">${fmtBRL(curr.cpa)}</div>
                        <div class="mt-1">${deltaHtml}</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-slate-700">
                        <p class="text-xs text-gray-400">O CPA √© o principal indicador de sa√∫de financeira da campanha.</p>
                    </div>
                </div>
            `;
        }

        function renderCharts(monthly, campaignData) {
            // Configura√ß√£o de Cores baseada no Tema
            const txtColor = isDarkMode ? '#94a3b8' : '#64748b';
            const gridColor = isDarkMode ? '#334155' : '#e2e8f0';
            
            // Helper para criar gradientes com contexto do canvas
            const createGradientForCanvas = (canvas, color1, color2) => {
                const ctx = canvas.getContext('2d');
                // Usar altura do canvas ou altura do container (320px para h-80)
                const height = canvas.height || canvas.parentElement?.clientHeight || 320;
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            };

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false, // Necess√°rio para controlar o tamanho via div pai (h-XX)
                plugins: { legend: { labels: { color: txtColor } } },
                scales: {
                    x: { ticks: { color: txtColor }, grid: { color: gridColor } },
                    y: { ticks: { color: txtColor }, grid: { color: gridColor } }
                }
            };

            // 1. Investimento vs Vendas
            const canvasInv = document.getElementById('investimentoVendasChart');
            const invVendasGradient = createGradientForCanvas(canvasInv, '#6366f1', '#4f46e5');
            if(chartInstances.invSales) chartInstances.invSales.destroy();
            chartInstances.invSales = new Chart(canvasInv, {
                type: 'bar',
                data: {
                    labels: monthly.map(d => d.mes),
                    datasets: [
                        { 
                            label: 'Investimento (R$)', 
                            data: monthly.map(d => d.inv), 
                            backgroundColor: invVendasGradient, 
                            order: 2 
                        },
                        { 
                            label: 'Vendas', 
                            data: monthly.map(d => d.vendas), 
                            type: 'line', 
                            borderColor: '#f97316', 
                            backgroundColor: 'rgba(249, 115, 22, 0.1)', 
                            borderWidth: 3, 
                            tension: 0.3, 
                            yAxisID: 'y1', 
                            order: 1,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: true
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, title: {display:true, text:'R$', color: txtColor} },
                        y1: { position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'Qtd', color: txtColor}, ticks: {color: txtColor} }
                    }
                }
            });

            // 2. Leads vs Vendas (Barras para Leads, Linha para Vendas)
            const canvasLeads = document.getElementById('leadsVendasVolumeChart');
            const leadsGradient = createGradientForCanvas(canvasLeads, '#06b6d4', '#0891b2');
            if(chartInstances.leadsSales) chartInstances.leadsSales.destroy();
            chartInstances.leadsSales = new Chart(canvasLeads, {
                type: 'bar',
                data: {
                    labels: monthly.map(d => d.mes),
                    datasets: [
                        { 
                            label: 'Leads', 
                            data: monthly.map(d => d.leads), 
                            backgroundColor: leadsGradient,
                            order: 2,
                            yAxisID: 'y'
                        },
                        { 
                            label: 'Vendas', 
                            data: monthly.map(d => d.vendas), 
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            fill: true,
                            order: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { 
                            ...commonOptions.scales.y, 
                            position: 'left',
                            title: {display:true, text:'Leads', color: txtColor},
                            beginAtZero: true
                        },
                        y1: { 
                            position: 'right', 
                            grid: {drawOnChartArea: false}, 
                            title: {display:true, text:'Vendas', color: txtColor}, 
                            ticks: {color: txtColor},
                            beginAtZero: true
                        }
                    }
                }
            });

            // 3. Efici√™ncia (Line) com informa√ß√µes do m√™s anterior para CPA
            if(chartInstances.eff) chartInstances.eff.destroy();
            const canvasEff = document.getElementById('custoEficienciaChart');
            
            // Preparar labels com informa√ß√µes do m√™s anterior para CPA
            const cpaLabels = monthly.map((d, idx) => {
                if (idx === 0) return d.mes;
                const prev = monthly[idx - 1];
                const diff = d.cpa - prev.cpa;
                const pct = prev.cpa > 0 ? ((diff / prev.cpa) * 100) : 0;
                const arrow = diff > 0 ? '‚ñ≤' : diff < 0 ? '‚ñº' : '‚Üí';
                const color = diff > 0 ? 'üî¥' : diff < 0 ? 'üü¢' : '‚ö™';
                return `${d.mes}\n${color} ${arrow} ${pct.toFixed(1)}%`;
            });
            
            chartInstances.eff = new Chart(canvasEff, {
                type: 'line',
                data: {
                    labels: monthly.map(d => d.mes),
                    datasets: [
                        { 
                            label: 'CPL', 
                            data: monthly.map(d => d.cpl), 
                            borderColor: '#22c55e', 
                            backgroundColor: 'rgba(34, 197, 94, 0.1)', 
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#22c55e',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            fill: true
                        },
                        { 
                            label: 'CPA', 
                            data: monthly.map(d => d.cpa), 
                            borderColor: '#ef4444', 
                            backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            fill: true
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            callbacks: {
                                afterBody: (items) => {
                                    const dataIndex = items[0].dataIndex;
                                    if (dataIndex > 0) {
                                        const curr = monthly[dataIndex];
                                        const prev = monthly[dataIndex - 1];
                                        const diff = curr.cpa - prev.cpa;
                                        const pct = prev.cpa > 0 ? ((diff / prev.cpa) * 100) : 0;
                                        return [
                                            `M√™s anterior: ${fmtBRL(prev.cpa)}`,
                                            `Varia√ß√£o: ${diff > 0 ? '+' : ''}${fmtBRL(diff)} (${pct > 0 ? '+' : ''}${pct.toFixed(1)}%)`
                                        ];
                                    }
                                    return null;
                                }
                            }
                        }
                    }
                }
            });

            // 4. TOP 5 Campanhas (Doughnut)
            if(chartInstances.topCamp) chartInstances.topCamp.destroy();
            
            // Preparar dados: Ordenar por vendas, pegar top 5, agrupar resto
            let sortedCamps = [...campaignData].sort((a,b) => b.vendas - a.vendas);
            let labelsPie = [], dataPie = [];
            
            if (sortedCamps.length > 5) {
                const top5 = sortedCamps.slice(0, 5);
                const others = sortedCamps.slice(5).reduce((acc, c) => acc + c.vendas, 0);
                labelsPie = top5.map(c => c.campanha);
                dataPie = top5.map(c => c.vendas);
                if(others > 0) { labelsPie.push('Outras'); dataPie.push(others); }
            } else {
                labelsPie = sortedCamps.map(c => c.campanha);
                dataPie = sortedCamps.map(c => c.vendas);
            }

            // Criar gradientes para o gr√°fico de rosca
            const canvasTop = document.getElementById('topCampaignsChart');
            const colors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#94a3b8'];
            
            chartInstances.topCamp = new Chart(canvasTop, {
                type: 'doughnut',
                data: {
                    labels: labelsPie,
                    datasets: [{
                        data: dataPie,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: txtColor, boxWidth: 12, font: {size: 11} } }
                    },
                    layout: { padding: 10 }
                }
            });
        }

        // --- Tables ---
        function renderSummaryTable(data) {
            if (data.length === 0) return;
            
            // Calcular min/max para cada m√©trica (exceto m√™s)
            const invValues = data.map(d => d.inv).filter(v => v !== null && !isNaN(v));
            const leadsValues = data.map(d => d.leads).filter(v => v !== null && !isNaN(v));
            const vendasValues = data.map(d => d.vendas).filter(v => v !== null && !isNaN(v));
            const cplValues = data.map(d => d.cpl).filter(v => v !== null && !isNaN(v) && v > 0);
            const cpaValues = data.map(d => d.cpa).filter(v => v !== null && !isNaN(v) && v > 0);
            
            const invMin = Math.min(...invValues), invMax = Math.max(...invValues);
            const leadsMin = Math.min(...leadsValues), leadsMax = Math.max(...leadsValues);
            const vendasMin = Math.min(...vendasValues), vendasMax = Math.max(...vendasValues);
            const cplMin = Math.min(...cplValues), cplMax = Math.max(...cplValues);
            const cpaMin = Math.min(...cpaValues), cpaMax = Math.max(...cpaValues);
            
            const tb = document.getElementById('data-table-body');
            tb.innerHTML = data.map(d => `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-700 transition">
                    <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">${d.mes}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-300" style="${getHeatMapColor(d.inv, invMin, invMax, isDarkMode)}">${fmtBRL(d.inv)}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-300" style="${getHeatMapColor(d.leads, leadsMin, leadsMax, isDarkMode)}">${fmtNum(d.leads)}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-300" style="${getHeatMapColor(d.vendas, vendasMin, vendasMax, isDarkMode)}">${fmtNum(d.vendas)}</td>
                    <td class="px-4 py-3 text-green-600 font-medium" style="${d.cpl > 0 ? getHeatMapColor(d.cpl, cplMin, cplMax, isDarkMode) : ''}">${fmtBRL(d.cpl)}</td>
                    <td class="px-4 py-3 ${getCpaColor(d.cpa)}" style="${d.cpa > 0 ? getHeatMapColor(d.cpa, cpaMin, cpaMax, isDarkMode) : ''}">${fmtBRL(d.cpa)}</td>
                </tr>
            `).join('');
        }

        function renderDetailedTable(data) {
            const tb = document.getElementById('detailed-table-body');
            
            if (data.length === 0) {
                tb.innerHTML = '';
                return;
            }
            
            // Calcular min/max para cada m√©trica para o mapa de calor
            const allInvValues = data.map(d => d.investimento).filter(v => v !== null && !isNaN(v));
            const allImpValues = data.map(d => d.impressoes).filter(v => v !== null && !isNaN(v));
            const allClickValues = data.map(d => d.cliques).filter(v => v !== null && !isNaN(v));
            const allLeadsValues = data.map(d => d.leads).filter(v => v !== null && !isNaN(v));
            const allVendasValues = data.map(d => d.vendas).filter(v => v !== null && !isNaN(v));
            const allCplValues = data.map(d => d.cpl).filter(v => v !== null && !isNaN(v) && v > 0);
            const allCpaValues = data.map(d => d.cpa).filter(v => v !== null && !isNaN(v) && v > 0);
            
            const invMin = Math.min(...allInvValues), invMax = Math.max(...allInvValues);
            const impMin = Math.min(...allImpValues), impMax = Math.max(...allImpValues);
            const clickMin = Math.min(...allClickValues), clickMax = Math.max(...allClickValues);
            const leadsMin = Math.min(...allLeadsValues), leadsMax = Math.max(...allLeadsValues);
            const vendasMin = Math.min(...allVendasValues), vendasMax = Math.max(...allVendasValues);
            const cplMin = Math.min(...allCplValues), cplMax = Math.max(...allCplValues);
            const cpaMin = Math.min(...allCpaValues), cpaMax = Math.max(...allCpaValues);
            
            // Agrupar dados por m√™s e depois por campanha
            const groupedByMonth = data.reduce((acc, item) => {
                if (!acc[item.mes]) {
                    acc[item.mes] = {};
                }
                if (!acc[item.mes][item.campanha]) {
                    acc[item.mes][item.campanha] = [];
                }
                acc[item.mes][item.campanha].push(item);
                return acc;
            }, {});

            // Ordenar meses
            const monthOrder = ['ago/2025', 'set/2025', 'out/2025', 'nov/2025', 'dez/2025'];
            const sortedMonths = Object.keys(groupedByMonth).sort((a, b) => {
                return monthOrder.indexOf(a) - monthOrder.indexOf(b);
            });

            let html = '';
            sortedMonths.forEach((mes, monthIndex) => {
                const monthData = groupedByMonth[mes];
                const campaigns = Object.keys(monthData);
                
                // Calcular totais do m√™s
                const monthTotals = campaigns.reduce((totals, camp) => {
                    monthData[camp].forEach(item => {
                        totals.investimento += item.investimento;
                        totals.impressoes += item.impressoes;
                        totals.cliques += item.cliques;
                        totals.leads += item.leads;
                        totals.vendas += item.vendas;
                    });
                    return totals;
                }, { investimento: 0, impressoes: 0, cliques: 0, leads: 0, vendas: 0 });
                
                const monthCPL = monthTotals.leads ? monthTotals.investimento / monthTotals.leads : 0;
                const monthCPA = monthTotals.vendas ? monthTotals.investimento / monthTotals.vendas : 0;
                
                // Linha de cabe√ßalho do m√™s (sempre vis√≠vel, clic√°vel)
                const monthId = `month-${monthIndex}`;
                html += `
                    <tr class="bg-indigo-50 dark:bg-indigo-900 bg-opacity-50 hover:bg-indigo-100 dark:hover:bg-indigo-800 cursor-pointer border-b-2 border-indigo-300 dark:border-indigo-600" 
                        onclick="toggleGroup('${monthId}')">
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300">
                            <i class="fas fa-chevron-down transition-transform duration-200" id="icon-${monthId}"></i>
                            <span class="ml-2">${mes}</span>
                        </td>
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300">TOTAL DO M√äS</td>
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300" style="${getHeatMapColor(monthTotals.investimento, invMin, invMax, isDarkMode)}">${fmtBRL(monthTotals.investimento)}</td>
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300 text-xs" style="${getHeatMapColor(monthTotals.impressoes, impMin, impMax, isDarkMode)}">${fmtNum(monthTotals.impressoes)}</td>
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300 text-xs" style="${getHeatMapColor(monthTotals.cliques, clickMin, clickMax, isDarkMode)}">${fmtNum(monthTotals.cliques)}</td>
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300" style="${getHeatMapColor(monthTotals.leads, leadsMin, leadsMax, isDarkMode)}">${fmtNum(monthTotals.leads)}</td>
                        <td class="px-4 py-3 font-bold text-indigo-700 dark:text-indigo-300" style="${getHeatMapColor(monthTotals.vendas, vendasMin, vendasMax, isDarkMode)}">${fmtNum(monthTotals.vendas)}</td>
                        <td class="px-4 py-3 font-bold text-green-600 dark:text-green-400" style="${monthCPL > 0 ? getHeatMapColor(monthCPL, cplMin, cplMax, isDarkMode) : ''}">${fmtBRL(monthCPL)}</td>
                        <td class="px-4 py-3 font-bold ${getCpaColor(monthCPA)}" style="${monthCPA > 0 ? getHeatMapColor(monthCPA, cpaMin, cpaMax, isDarkMode) : ''}">${fmtBRL(monthCPA)}</td>
                    </tr>
                `;
                
                // Agrupar campanhas do m√™s
                campaigns.forEach((campanha, campIndex) => {
                    const campaignData = monthData[campanha];
                    
                    // Calcular totais da campanha
                    const campTotals = campaignData.reduce((totals, item) => {
                        totals.investimento += item.investimento;
                        totals.impressoes += item.impressoes;
                        totals.cliques += item.cliques;
                        totals.leads += item.leads;
                        totals.vendas += item.vendas;
                        return totals;
                    }, { investimento: 0, impressoes: 0, cliques: 0, leads: 0, vendas: 0 });
                    
                    const campCPL = campTotals.leads ? campTotals.investimento / campTotals.leads : 0;
                    const campCPA = campTotals.vendas ? campTotals.investimento / campTotals.vendas : 0;
                    
                    const campId = `${monthId}-camp-${campIndex}`;
                    
                    // Linha de cabe√ßalho da campanha (dentro do m√™s, colaps√°vel)
                    html += `
                        <tr class="group-month-${monthId} bg-blue-50 dark:bg-blue-900 bg-opacity-30 hover:bg-blue-100 dark:hover:bg-blue-800 cursor-pointer transition-colors" 
                            onclick="toggleGroup('${campId}', event)">
                            <td class="px-4 py-2 pl-8 text-gray-600 dark:text-gray-400">
                                <i class="fas fa-chevron-right transition-transform duration-200 text-xs" id="icon-${campId}"></i>
                            </td>
                            <td class="px-4 py-2 font-semibold text-blue-700 dark:text-blue-300 text-xs">
                                ${campanha}
                            </td>
                            <td class="px-4 py-2 font-semibold text-blue-700 dark:text-blue-300" style="${getHeatMapColor(campTotals.investimento, invMin, invMax, isDarkMode)}">${fmtBRL(campTotals.investimento)}</td>
                            <td class="px-4 py-2 font-semibold text-blue-700 dark:text-blue-300 text-xs" style="${getHeatMapColor(campTotals.impressoes, impMin, impMax, isDarkMode)}">${fmtNum(campTotals.impressoes)}</td>
                            <td class="px-4 py-2 font-semibold text-blue-700 dark:text-blue-300 text-xs" style="${getHeatMapColor(campTotals.cliques, clickMin, clickMax, isDarkMode)}">${fmtNum(campTotals.cliques)}</td>
                            <td class="px-4 py-2 font-semibold text-blue-700 dark:text-blue-300" style="${getHeatMapColor(campTotals.leads, leadsMin, leadsMax, isDarkMode)}">${fmtNum(campTotals.leads)}</td>
                            <td class="px-4 py-2 font-semibold text-blue-700 dark:text-blue-300" style="${getHeatMapColor(campTotals.vendas, vendasMin, vendasMax, isDarkMode)}">${fmtNum(campTotals.vendas)}</td>
                            <td class="px-4 py-2 font-semibold text-green-600 dark:text-green-400" style="${campCPL > 0 ? getHeatMapColor(campCPL, cplMin, cplMax, isDarkMode) : ''}">${fmtBRL(campCPL)}</td>
                            <td class="px-4 py-2 font-semibold ${getCpaColor(campCPA)}" style="${campCPA > 0 ? getHeatMapColor(campCPA, cpaMin, cpaMax, isDarkMode) : ''}">${fmtBRL(campCPA)}</td>
                        </tr>
                    `;
                    
                    // Linhas de detalhes da campanha (colaps√°veis)
                    campaignData.forEach(item => {
                        html += `
                            <tr class="group-month-${monthId} group-camp-${campId} hover:bg-gray-50 dark:hover:bg-slate-700 transition border-b dark:border-slate-700">
                                <td class="px-4 py-2 pl-12 text-gray-500 dark:text-gray-400 text-xs">${item.mes}</td>
                                <td class="px-4 py-2 pl-8 text-gray-600 dark:text-gray-300 text-xs">${item.campanha}</td>
                                <td class="px-4 py-2 text-gray-600 dark:text-gray-300" style="${getHeatMapColor(item.investimento, invMin, invMax, isDarkMode)}">${fmtBRL(item.investimento)}</td>
                                <td class="px-4 py-2 text-gray-500 dark:text-gray-400 text-xs" style="${getHeatMapColor(item.impressoes, impMin, impMax, isDarkMode)}">${fmtNum(item.impressoes)}</td>
                                <td class="px-4 py-2 text-gray-500 dark:text-gray-400 text-xs" style="${getHeatMapColor(item.cliques, clickMin, clickMax, isDarkMode)}">${fmtNum(item.cliques)}</td>
                                <td class="px-4 py-2 text-gray-600 dark:text-gray-300" style="${getHeatMapColor(item.leads, leadsMin, leadsMax, isDarkMode)}">${fmtNum(item.leads)}</td>
                                <td class="px-4 py-2 text-gray-600 dark:text-gray-300" style="${getHeatMapColor(item.vendas, vendasMin, vendasMax, isDarkMode)}">${fmtNum(item.vendas)}</td>
                                <td class="px-4 py-2 text-green-600 font-medium" style="${item.cpl > 0 ? getHeatMapColor(item.cpl, cplMin, cplMax, isDarkMode) : ''}">${fmtBRL(item.cpl)}</td>
                                <td class="px-4 py-2 ${getCpaColor(item.cpa)}" style="${item.cpa > 0 ? getHeatMapColor(item.cpa, cpaMin, cpaMax, isDarkMode) : ''}">${fmtBRL(item.cpa)}</td>
                            </tr>
                        `;
                    });
                });
            });
            
            tb.innerHTML = html;
            
            // Inicializar todos os grupos como expandidos
            // As linhas come√ßam como display: table-row por padr√£o no CSS inline
        }

        // Fun√ß√£o global para expandir/colapsar grupos
        function toggleGroup(groupId, event) {
            if (event) {
                event.stopPropagation(); // Prevenir propaga√ß√£o do clique
            }
            
            const icon = document.getElementById(`icon-${groupId}`);
            const isMonthGroup = groupId.startsWith('month-') && !groupId.includes('camp-');
            
            if (isMonthGroup) {
                // Toggle de m√™s: mostra/oculta todas as campanhas e seus detalhes
                const rows = document.querySelectorAll(`.group-month-${groupId}`);
                let isExpanded = true;
                
                // Verificar se est√° expandido (primeira linha vis√≠vel)
                if (rows.length > 0) {
                    const firstRow = rows[0];
                    const computedStyle = window.getComputedStyle(firstRow);
                    isExpanded = computedStyle.display !== 'none';
                }
                
                rows.forEach(row => {
                    row.style.display = isExpanded ? 'none' : 'table-row';
                });
                
                // Rotacionar √≠cone
                if (icon) {
                    icon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
                }
            } else {
                // Toggle de campanha: mostra/oculta apenas os detalhes da campanha
                const rows = document.querySelectorAll(`.group-camp-${groupId}`);
                let isExpanded = true;
                
                // Verificar se est√° expandido
                if (rows.length > 0) {
                    const firstRow = rows[0];
                    const computedStyle = window.getComputedStyle(firstRow);
                    isExpanded = computedStyle.display !== 'none';
                }
                
                rows.forEach(row => {
                    row.style.display = isExpanded ? 'none' : 'table-row';
                });
                
                // Rotacionar √≠cone (direita quando colapsado, baixo quando expandido)
                if (icon) {
                    if (isExpanded) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            }
        }
        
        // Expor fun√ß√£o globalmente
        window.toggleGroup = toggleGroup;

        // --- Export ---
        function downloadCSV() {
            const data = getFilteredData();
            if(!data.length) return alert('Sem dados');
            let csv = "Mes;Campanha;Investimento;Leads;Vendas;CPL;CPA\n";
            data.forEach(d => {
                csv += `${d.mes};${d.campanha};${d.investimento.toFixed(2).replace('.', ',')};${d.leads};${d.vendas};${d.cpl.toFixed(2).replace('.', ',')};${(d.cpa||0).toFixed(2).replace('.', ',')}\n`;
            });
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "performance_ads.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadPDF() {
            // For√ßa tema claro para PDF
            const wasDark = document.documentElement.classList.contains('dark');
            if(wasDark) toggleTheme();

            const el = document.getElementById('app');
            const opt = {
                margin: 5, filename: 'Performance_Roselaine_Portal.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            // Usar promise para garantir que o tema seja restaurado
            html2pdf().set(opt).from(el).save().then(() => {
                // Restaura tema se necess√°rio
                if(wasDark) toggleTheme();
            });
        }

        // Init
        document.getElementById('month-filter').addEventListener('change', updateReport);
        document.getElementById('campaign-filter').addEventListener('change', updateReport);
        window.onload = () => { 
            // Inicializa tema baseado na prefer√™ncia do sistema se n√£o houver estado salvo
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                isDarkMode = true;
            } else {
                document.documentElement.classList.remove('dark');
                isDarkMode = false;
            }
            // Atualiza o √≠cone
            document.getElementById('theme-icon').className = isDarkMode ? 'fas fa-sun text-yellow-300 text-lg w-6 h-6 flex items-center justify-center' : 'fas fa-moon text-gray-700 text-lg w-6 h-6 flex items-center justify-center';

            populateFilters(); 
            updateReport(); 
        };

        // Define as fun√ß√µes de download no escopo global para o onclick
        window.downloadCSV = downloadCSV;
        window.downloadPDF = downloadPDF;
        window.toggleTheme = toggleTheme;
    </script>
</body>
</html>